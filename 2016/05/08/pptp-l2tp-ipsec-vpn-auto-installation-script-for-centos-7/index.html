<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="format-detection" content="email=no"><meta name="description" content="一个美男子的前端技术博客。"><meta name="keywords" content="Hexo, Gruntjs, Nodejs, Reactjs, Vuejs"><title>CentOS 7 安装 VPN （PPTP、L2TP、IPSec） - 啦啦啦撸啊撸</title><link rel="stylesheet" href="/css/main_style.min.css"><link rel="icon" href="/favicon.ico"></head><body><div class="post-header"><img class="background" src="http://callfiles.ueibo.com/hexo-theme-laughing/post_background.jpg"><div class="post-title"><h1 class="title">CentOS 7 安装 VPN （PPTP、L2TP、IPSec）</h1><ul class="meta"><li><i class="icon icon-author"></i>Heleth</li><li><i class="icon icon-clock"></i>29 Minutes</li><li><i class="icon icon-calendar"></i>May 8, 2016</li></ul></div></div><div class="article-content" style="max-width:600px"><p>在百度搜索了很多关于CentOS7搭建VPN的教程，但是有很多走不完全套的，因此浪费了很多时间，在这里我把查到能走通的教程整理了一遍，分享给大家。</p>
<a id="more"></a>
<h3 id="更新组件"><a href="#更新组件" class="headerlink" title="更新组件"></a>更新组件</h3><p>整个安装过程不用经过编译，组件都是在yum中下载，首先我们更新一下所有组件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum update -y</div></pre></td></tr></table></figure>
<p>这里有个地方需要注意的是：有些主机的硬件并不支持最新内核，因此在不确定的情况下就不要升级内核了，用以下的命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum –exclude=kernel* update -y</div></pre></td></tr></table></figure>
<p>更新需要较长时间，请耐心等待。</p>
<h3 id="非常重要的小插曲"><a href="#非常重要的小插曲" class="headerlink" title="非常重要的小插曲"></a>非常重要的小插曲</h3><p>撰写这篇文章并且共享出来，主要是为了能和大家互相学习和交流，但是正在看这篇文章的不乏一些现在就有自己的服务器或VPS，急着马上搭建好一台自己的VPN服务器的同学，如果你是这类同学，请不用心急，因为我制作好了自动运行脚本，脚本的内容和文章内容是一样的，把脚本下载到服务器，运行并配置自己的账号密码、ip和客户端ip即可。</p>
<p>脚本下载地址：<a href="https://github.com/BoizZ/PPTP-L2TP-IPSec-VPN-auto-installation-script-for-CentOS-7" target="_blank" rel="external">https://github.com/BoizZ/PPTP-L2TP-IPSec-VPN-auto-installation-script-for-CentOS-7</a></p>
<p>运行脚本：<code>sh vpn-script-for-centos7.sh</code></p>
<p>好，那么希望继续学习的同学请往下看。</p>
<h3 id="安装epel源"><a href="#安装epel源" class="headerlink" title="安装epel源"></a>安装epel源</h3><p>为什么要安装epel源呢？是因为必要组件xl2tpd在基础的yum源里面是没有的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install epel-release -y</div></pre></td></tr></table></figure>
<h3 id="安装依赖组件"><a href="#安装依赖组件" class="headerlink" title="安装依赖组件"></a>安装依赖组件</h3><p>安装完epel源以后就可以直接安装依赖组件了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install -y openswan ppp pptpd xl2tpd wget</div></pre></td></tr></table></figure>
<h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><p>需要等待所有依赖组件安装完成才能执行以下步骤（小标题括号内是文件路径）。</p>
<h4 id="ipsec-conf配置文件（-etc-ipsec-conf）"><a href="#ipsec-conf配置文件（-etc-ipsec-conf）" class="headerlink" title="ipsec.conf配置文件（/etc/ipsec.conf）"></a>ipsec.conf配置文件（<code>/etc/ipsec.conf</code>）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># /etc/ipsec.conf - Libreswan IPsec configuration file</span></div><div class="line"><span class="comment"># This file:  /etc/ipsec.conf</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># Enable when using this configuration file with openswan instead of libreswan</span></div><div class="line"><span class="comment">#version 2</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># Manual:     ipsec.conf.5</span></div><div class="line"><span class="comment"># basic configuration</span></div><div class="line">config setup</div><div class="line">    <span class="comment"># NAT-TRAVERSAL support, see README.NAT-Traversal</span></div><div class="line">    nat_traversal=yes</div><div class="line">    <span class="comment"># exclude networks used on server side by adding %v4:!a.b.c.0/24</span></div><div class="line">    virtual_private=%v4:10.0.0.0/8,%v4:192.168.0.0/16,%v4:172.16.0.0/12</div><div class="line">    <span class="comment"># OE is now off by default. Uncomment and change to on, to enable.</span></div><div class="line">    oe=off</div><div class="line">    <span class="comment"># which IPsec stack to use. auto will try netkey, then klips then mast</span></div><div class="line">    protostack=netkey</div><div class="line">    force_keepalive=yes</div><div class="line">    keep_alive=1800</div><div class="line">conn L2TP-PSK-NAT</div><div class="line">    rightsubnet=vhost:%priv</div><div class="line">    also=L2TP-PSK-noNAT</div><div class="line">conn L2TP-PSK-noNAT</div><div class="line">    authby=secret</div><div class="line">    pfs=no</div><div class="line">    auto=add</div><div class="line">    keyingtries=3</div><div class="line">    rekey=no</div><div class="line">    ikelifetime=8h</div><div class="line">    keylife=1h</div><div class="line">    <span class="built_in">type</span>=transport</div><div class="line">    left=<span class="variable">$serverip</span></div><div class="line">    leftid=<span class="variable">$serverip</span></div><div class="line">    leftprotoport=17/1701</div><div class="line">    right=%any</div><div class="line">    rightprotoport=17/%any</div><div class="line">    dpddelay=40</div><div class="line">    dpdtimeout=130</div><div class="line">    dpdaction=clear</div><div class="line"><span class="comment"># For example connections, see your distribution's documentation directory,</span></div><div class="line"><span class="comment"># or the documentation which could be located at</span></div><div class="line"><span class="comment">#  /usr/share/docs/libreswan-3.*/ or look at https://www.libreswan.org/</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># There is also a lot of information in the manual page, "man ipsec.conf"</span></div><div class="line"><span class="comment"># You may put your configuration (.conf) file in the "/etc/ipsec.d/" directory</span></div><div class="line"><span class="comment"># by uncommenting this line</span></div><div class="line"><span class="comment">#include /etc/ipsec.d/*.conf</span></div></pre></td></tr></table></figure>
<h4 id="设置预共享密钥配置文件（-etc-ipsec-secrets）"><a href="#设置预共享密钥配置文件（-etc-ipsec-secrets）" class="headerlink" title="设置预共享密钥配置文件（/etc/ipsec.secrets）"></a>设置预共享密钥配置文件（<code>/etc/ipsec.secrets</code>）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#include /etc/ipsec.d/*.secrets</span></div><div class="line"><span class="variable">$serverip</span> username PSK password</div></pre></td></tr></table></figure>
<p>注解：第二行中username为登录名，password为登录密码</p>
<h4 id="pptpd-conf配置文件-etc-pptpd-conf"><a href="#pptpd-conf配置文件-etc-pptpd-conf" class="headerlink" title="pptpd.conf配置文件(/etc/pptpd.conf)"></a>pptpd.conf配置文件(<code>/etc/pptpd.conf</code>)</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#ppp /usr/sbin/pppd</span></div><div class="line">option /etc/ppp/options.pptpd</div><div class="line"><span class="comment">#debug</span></div><div class="line"><span class="comment"># stimeout 10</span></div><div class="line"><span class="comment">#noipparam</span></div><div class="line">logwtmp</div><div class="line"><span class="comment">#vrf test</span></div><div class="line"><span class="comment">#bcrelay eth1</span></div><div class="line"><span class="comment">#delegate</span></div><div class="line"><span class="comment">#connections 100</span></div><div class="line">localip 10.0.1.2</div><div class="line">remoteip 10.0.1.200-254</div></pre></td></tr></table></figure>
<h4 id="xl2tpd-conf配置文件-etc-xl2tpd-xl2tpd-conf"><a href="#xl2tpd-conf配置文件-etc-xl2tpd-xl2tpd-conf" class="headerlink" title="xl2tpd.conf配置文件(/etc/xl2tpd/xl2tpd.conf)"></a>xl2tpd.conf配置文件(<code>/etc/xl2tpd/xl2tpd.conf</code>)</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">;</div><div class="line">; This is a minimal sample xl2tpd configuration file <span class="keyword">for</span> use</div><div class="line">; with L2TP over IPsec.</div><div class="line">;</div><div class="line">; The idea is to provide an L2TP daemon to <span class="built_in">which</span> remote Windows L2TP/IPsec</div><div class="line">; clients connect. In this example, the internal (protected) network</div><div class="line">; is 192.168.1.0/24.  A special IP range within this network is reserved</div><div class="line">; <span class="keyword">for</span> the remote clients: 192.168.1.128/25</div><div class="line">; (i.e. 192.168.1.128 ... 192.168.1.254)</div><div class="line">;</div><div class="line">; The listen-addr parameter can be used <span class="keyword">if</span> you want to <span class="built_in">bind</span> the L2TP daemon</div><div class="line">; to a specific IP address instead of to all interfaces. For instance,</div><div class="line">; you could <span class="built_in">bind</span> it to the interface of the internal LAN (e.g. 192.168.1.98</div><div class="line">; <span class="keyword">in</span> the example below). Yet another IP address (<span class="built_in">local</span> ip, e.g. 192.168.1.99)</div><div class="line">; will be used by xl2tpd as its address on pppX interfaces.</div><div class="line">[global]</div><div class="line">; ipsec saref = yes</div><div class="line">listen-addr = 104.171.165.91</div><div class="line">auth file = /etc/ppp/chap-secrets</div><div class="line">port = 1701</div><div class="line">[lns default]</div><div class="line">ip range = 10.0.1.100-10.0.1.254</div><div class="line"><span class="built_in">local</span> ip = 10.0.1.1</div><div class="line">refuse chap = yes</div><div class="line">refuse pap = yes</div><div class="line">require authentication = yes</div><div class="line">name = L2TPVPN</div><div class="line">ppp debug = yes</div><div class="line">pppoptfile = /etc/ppp/options.xl2tpd</div><div class="line">length bit = yes</div></pre></td></tr></table></figure>
<h4 id="options-pptpd配置文件-etc-ppp-options-pptpd"><a href="#options-pptpd配置文件-etc-ppp-options-pptpd" class="headerlink" title="options.pptpd配置文件(/etc/ppp/options.pptpd)"></a>options.pptpd配置文件(<code>/etc/ppp/options.pptpd</code>)</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Authentication</span></div><div class="line">name pptpd</div><div class="line"><span class="comment">#chapms-strip-domain</span></div><div class="line"><span class="comment"># Encryption</span></div><div class="line"><span class="comment"># BSD licensed ppp-2.4.2 upstream with MPPE only, kernel module ppp_mppe.o</span></div><div class="line"><span class="comment"># &#123;&#123;&#123;</span></div><div class="line">refuse-pap</div><div class="line">refuse-chap</div><div class="line">refuse-mschap</div><div class="line"><span class="comment"># Require the peer to authenticate itself using MS-CHAPv2 [Microsoft</span></div><div class="line"><span class="comment"># Challenge Handshake Authentication Protocol, Version 2] authentication.</span></div><div class="line">require-mschap-v2</div><div class="line"><span class="comment"># Require MPPE 128-bit encryption</span></div><div class="line"><span class="comment"># (note that MPPE requires the use of MSCHAP-V2 during authentication)</span></div><div class="line">require-mppe-128</div><div class="line"><span class="comment"># &#125;&#125;&#125;</span></div><div class="line"><span class="comment"># OpenSSL licensed ppp-2.4.1 fork with MPPE only, kernel module mppe.o</span></div><div class="line"><span class="comment"># &#123;&#123;&#123;</span></div><div class="line"><span class="comment">#-chap</span></div><div class="line"><span class="comment">#-chapms</span></div><div class="line"><span class="comment"># Require the peer to authenticate itself using MS-CHAPv2 [Microsoft</span></div><div class="line"><span class="comment"># Challenge Handshake Authentication Protocol, Version 2] authentication.</span></div><div class="line"><span class="comment">#+chapms-v2</span></div><div class="line"><span class="comment"># Require MPPE encryption</span></div><div class="line"><span class="comment"># (note that MPPE requires the use of MSCHAP-V2 during authentication)</span></div><div class="line"><span class="comment">#mppe-40    # enable either 40-bit or 128-bit, not both</span></div><div class="line"><span class="comment">#mppe-128</span></div><div class="line"><span class="comment">#mppe-stateless</span></div><div class="line"><span class="comment"># &#125;&#125;&#125;</span></div><div class="line">ms-dns 8.8.4.4</div><div class="line">ms-dns 8.8.8.8</div><div class="line"><span class="comment">#ms-wins 10.0.0.3</span></div><div class="line"><span class="comment">#ms-wins 10.0.0.4</span></div><div class="line">proxyarp</div><div class="line"><span class="comment">#10.8.0.100</span></div><div class="line"><span class="comment"># Logging</span></div><div class="line"><span class="comment">#debug</span></div><div class="line"><span class="comment">#dump</span></div><div class="line">lock</div><div class="line">nobsdcomp </div><div class="line">novj</div><div class="line">novjccomp</div><div class="line">nologfd</div></pre></td></tr></table></figure>
<h4 id="options-xl2tpd配置文件-etc-ppp-options-xl2tpd"><a href="#options-xl2tpd配置文件-etc-ppp-options-xl2tpd" class="headerlink" title="options.xl2tpd配置文件(/etc/ppp/options.xl2tpd)"></a>options.xl2tpd配置文件(<code>/etc/ppp/options.xl2tpd</code>)</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">rm <span class="_">-f</span> /etc/ppp/options.xl2tpd</div><div class="line">cat &gt;&gt;/etc/ppp/options.xl2tpd&lt;&lt;EOF</div><div class="line"><span class="comment">#require-pap</span></div><div class="line"><span class="comment">#require-chap</span></div><div class="line"><span class="comment">#require-mschap</span></div><div class="line">ipcp-accept-local</div><div class="line">ipcp-accept-remote</div><div class="line">require-mschap-v2</div><div class="line">ms-dns 8.8.8.8</div><div class="line">ms-dns 8.8.4.4</div><div class="line">asyncmap 0</div><div class="line">auth</div><div class="line">crtscts</div><div class="line">lock</div><div class="line">hide-password</div><div class="line">modem</div><div class="line">debug</div><div class="line">name l2tpd</div><div class="line">proxyarp</div><div class="line">lcp-echo-interval 30</div><div class="line">lcp-echo-failure 4</div><div class="line">mtu 1400</div><div class="line">noccp</div><div class="line">connect-delay 5000</div><div class="line"><span class="comment"># To allow authentication against a Windows domain EXAMPLE, and require the</span></div><div class="line"><span class="comment"># user to be in a group "VPN Users". Requires the samba-winbind package</span></div><div class="line"><span class="comment"># require-mschap-v2</span></div><div class="line"><span class="comment"># plugin winbind.so</span></div><div class="line"><span class="comment"># ntlm_auth-helper '/usr/bin/ntlm_auth --helper-protocol=ntlm-server-1 --require-membership-of="EXAMPLE\VPN Users"'</span></div><div class="line"><span class="comment"># You need to join the domain on the server, for example using samba:</span></div><div class="line"><span class="comment"># http://rootmanager.com/ubuntu-ipsec-l2tp-windows-domain-auth/setting-up-openswan-xl2tpd-with-native-windows-clients-lucid.html</span></div></pre></td></tr></table></figure>
<h4 id="创建chap-secrets配置文件，即用户列表及密码-etc-ppp-chap-secrets"><a href="#创建chap-secrets配置文件，即用户列表及密码-etc-ppp-chap-secrets" class="headerlink" title="创建chap-secrets配置文件，即用户列表及密码(/etc/ppp/chap-secrets)"></a>创建chap-secrets配置文件，即用户列表及密码(<code>/etc/ppp/chap-secrets</code>)</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Secrets for authentication using CHAP</span></div><div class="line"><span class="comment"># client     server     secret               IP addresses</span></div><div class="line">username          pptpd     password               *</div><div class="line">username          l2tpd     password               *</div></pre></td></tr></table></figure>
<p>注解：第三第四行中username为登录名，password为登录密码</p>
<h3 id="系统配置"><a href="#系统配置" class="headerlink" title="系统配置"></a>系统配置</h3><h4 id="允许IP转发"><a href="#允许IP转发" class="headerlink" title="允许IP转发"></a>允许IP转发</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">sysctl -w net.ipv4.ip_forward=1</div><div class="line">sysctl -w net.ipv4.conf.all.rp_filter=0</div><div class="line">sysctl -w net.ipv4.conf.default.rp_filter=0</div><div class="line">sysctl -w net.ipv4.conf.<span class="variable">$eth</span>.rp_filter=0</div><div class="line">sysctl -w net.ipv4.conf.all.send_redirects=0</div><div class="line">sysctl -w net.ipv4.conf.default.send_redirects=0</div><div class="line">sysctl -w net.ipv4.conf.all.accept_redirects=0</div><div class="line">sysctl -w net.ipv4.conf.default.accept_redirects=0</div></pre></td></tr></table></figure>
<p>注解：以上均是命令，复制上去运行即可</p>
<p>也可以修改配置文件(<code>/etc/sysctl.conf</code>)：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">net.ipv4.ip_forward = 1</div><div class="line">net.ipv4.conf.all.rp_filter = 0</div><div class="line">net.ipv4.conf.default.rp_filter = 0</div><div class="line">net.ipv4.conf.<span class="variable">$eth</span>.rp_filter = 0</div><div class="line">net.ipv4.conf.all.send_redirects = 0</div><div class="line">net.ipv4.conf.default.send_redirects = 0</div><div class="line">net.ipv4.conf.all.accept_redirects = 0</div><div class="line">net.ipv4.conf.default.accept_redirects = 0</div></pre></td></tr></table></figure>
<h4 id="允许防火墙端口"><a href="#允许防火墙端口" class="headerlink" title="允许防火墙端口"></a>允许防火墙端口</h4><p>创建文件<code>/usr/lib/firewalld/services/pptpd.xml</code>并修改：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">service</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">short</span>&gt;</span>pptpd<span class="tag">&lt;/<span class="name">short</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>PPTP<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">port</span> <span class="attr">protocol</span>=<span class="string">"tcp"</span> <span class="attr">port</span>=<span class="string">"1723"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">service</span>&gt;</span></div></pre></td></tr></table></figure>
<p>创建文件<code>/usr/lib/firewalld/services/l2tpd.xml</code>并修改：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">service</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">short</span>&gt;</span>l2tpd<span class="tag">&lt;/<span class="name">short</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>L2TP IPSec<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">port</span> <span class="attr">protocol</span>=<span class="string">"udp"</span> <span class="attr">port</span>=<span class="string">"500"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">port</span> <span class="attr">protocol</span>=<span class="string">"udp"</span> <span class="attr">port</span>=<span class="string">"4500"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">port</span> <span class="attr">protocol</span>=<span class="string">"udp"</span> <span class="attr">port</span>=<span class="string">"1701"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">service</span>&gt;</span></div></pre></td></tr></table></figure>
<h4 id="初始化并重启防火墙："><a href="#初始化并重启防火墙：" class="headerlink" title="初始化并重启防火墙："></a>初始化并重启防火墙：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">firewall-cmd --reload</div><div class="line">firewall-cmd --permanent --add-service=pptpd</div><div class="line">firewall-cmd --permanent --add-service=l2tpd</div><div class="line">firewall-cmd --permanent --add-service=ipsec</div><div class="line">firewall-cmd --permanent --add-masquerade</div><div class="line">firewall-cmd --permanent --direct --add-rule ipv4 filter FORWARD 0 -p tcp -i ppp+ -j TCPMSS --syn --set-mss 1356</div><div class="line">firewall-cmd --reload</div></pre></td></tr></table></figure>
<p>这里是由于CentOS7自带firewall，并且不预装iptables，因此自己也不多此一举去安装了，因为效果都是一样的。</p>
<h3 id="启动并设置开机自启动服务"><a href="#启动并设置开机自启动服务" class="headerlink" title="启动并设置开机自启动服务"></a>启动并设置开机自启动服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">systemctl <span class="built_in">enable</span> pptpd ipsec xl2tpd</div><div class="line">systemctl restart pptpd ipsec xl2tpd</div></pre></td></tr></table></figure>
<h3 id="大功告成"><a href="#大功告成" class="headerlink" title="大功告成"></a>大功告成</h3><p>最后一步，并且是最重要的一步，当然是连接一下自己刚建好的VPN服务器啦！</p>
<p>现在估计你和我有同样的喜悦，当然如果中间出现什么问题的话，交流区在下方，很乐意大家踊跃参与！</p>
<blockquote>
<p>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank" rel="external">创意共享3.0许可证</a>） 转载请注明出处</p>
</blockquote>
</div><div class="article-meta" style="max-width:600px"><div class="tags"><i class="icon icon-tag"></i><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CentOS/">CentOS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IPSec/">IPSec</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/L2TP/">L2TP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PPTP/">PPTP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/VPN/">VPN</a><span class="tag-list-count">1</span></li></ul></div><div class="categories"><i class="icon icon-category"></i><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Shell/">Shell</a><span class="category-list-count">1</span></li></ul></div></div><div class="article-comment" style="max-width:600px"><div class="ds-thread" id="ds-thread" data-thread-key="cizcmfeie0005lw2iykaheaaa" data-title="CentOS 7 安装 VPN （PPTP、L2TP、IPSec）" data-url="http://yoursite.com/2016/05/08/pptp-l2tp-ipsec-vpn-auto-installation-script-for-centos-7/" site-name="ueibo"></div><script>var siteName = document.getElementById('ds-thread').getAttribute('site-name');
var duoshuoQuery = {short_name: siteName};
(function() {
  var ds = document.createElement('script');
  ds.type = 'text/javascript';ds.async = true;
  ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
  ds.charset = 'UTF-8';
  (document.getElementsByTagName('head')[0] 
  || document.getElementsByTagName('body')[0]).appendChild(ds);
})();</script></div><ul class="navication"><li class="home"><a href="/"><i class="icon icon-home"></i></a></li><li><a href="/2016/05/28/ios-in-the-pop-up-after-the-emergence-of-fixed-keyboard-failure-solution/"><i class="icon icon-arror-left"></i></a></li><li><a href="/2015/11/10/flex-layout-old-and-new-compatible/"><i class="icon icon-arror-right"></i></a></li></ul><div class="page-footer"><div class="top"><ul class="social"><li><a href="http://github.com/BoizZ" title="GitHub" target="_blank"><i class="icon icon-github"></i></a></li><li><a href="http://weibo.com/heqibang" title="Weibo" target="_blank"><i class="icon icon-weibo"></i></a></li><li><a href="http://www.segmentfault.com/u/bon" title="SegmentFault" target="_blank"><i class="icon icon-segmentfault"></i></a></li></ul></div><div class="bottom"><p class="copyright">© 2017 啦啦啦撸啊撸<br><small>POWER BY <a href="https://hexo.io" target="_blank">HEXO</a></small><small>, THEME BY <a href="https://github.com/BoizZ/hexo-theme-laughing" target="_blank">LAUGHING</a></small></p></div></div></body></html>